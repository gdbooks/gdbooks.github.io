<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Cleaning Up | Introduction</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.3.0">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="gitbook/style.css">
    
    

        
    
    
    <link rel="next" href="./borders.html" />
    
    
    <link rel="prev" href="./Chapter11.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="9.1" data-basepath="." data-revision="Sun Sep 20 2015 04:05:17 GMT-0700 (Pacific Daylight Time)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        

        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="./index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="Chapter1.html">
            
                
                    <a href="./Chapter1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Starting Out
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="FrameworksSources.html">
            
                
                    <a href="./FrameworksSources.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Managers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="Game.html">
            
                
                    <a href="./Game.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Game
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="Program.html">
            
                
                    <a href="./Program.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Program
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="Chapter2.html">
            
                
                    <a href="./Chapter2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Why Tiles?
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="Chapter3.html">
            
                
                    <a href="./Chapter3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Map Format
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="Chapter6.html">
            
                
                    <a href="./Chapter6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Creating Tiles
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="Practice/PracticeCh6.html">
            
                
                    <a href="./Practice/PracticeCh6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        On Your Own
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="Chapter5.html">
            
                
                    <a href="./Chapter5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Map Tools
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="Chapter8.html">
            
                
                    <a href="./Chapter8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        The Hero
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1" data-path="Practice/PracticeTheHero.html">
            
                
                    <a href="./Practice/PracticeTheHero.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.1.</b>
                        
                        On Your Own
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="7" data-path="Chapter9.html">
            
                
                    <a href="./Chapter9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Keys To Move
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1" data-path="Practice/PracticeMoving.html">
            
                
                    <a href="./Practice/PracticeMoving.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.1.</b>
                        
                        On Your Own
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8" data-path="Chapter10.html">
            
                
                    <a href="./Chapter10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Hit The Wall
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="Chapter11.html">
            
                
                    <a href="./Chapter11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        Open The Door
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="9.1" data-path="cleanup.html">
            
                
                    <a href="./cleanup.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.1.</b>
                        
                        Cleaning Up
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9.2" data-path="borders.html">
            
                
                    <a href="./borders.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.2.</b>
                        
                        Screen Borders
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="10" data-path="Chapter12.html">
            
                
                    <a href="./Chapter12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        Jumping
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="10.1" data-path="jumpconfig.html">
            
                
                    <a href="./jumpconfig.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.1.</b>
                        
                        Configurable Jumping
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="11" data-path="Chapter13.html">
            
                
                    <a href="./Chapter13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        Clouds
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="Chapter15.html">
            
                
                    <a href="./Chapter15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        Simple Enemy
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="Chapter17.html">
            
                
                    <a href="./Chapter17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        Shooting
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="Chapter18.html">
            
                
                    <a href="./Chapter18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        Getting Items
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="Chapter20.html">
            
                
                    <a href="./Chapter20.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        Scrolling
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="15.1" data-path="Chapter21.html">
            
                
                    <a href="./Chapter21.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>15.1.</b>
                        
                        X Limit Scrolling
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="16" data-path="Chapter22.html">
            
                
                    <a href="./Chapter22.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        X Depth
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="Chapter23.html">
            
                
                    <a href="./Chapter23.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        X Ismetric View
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="Chapter24.html">
            
                
                    <a href="./Chapter24.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        X Mouse To Move
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="Chapter25.html">
            
                
                    <a href="./Chapter25.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        X Iso Mouse
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="Chapter26.html">
            
                
                    <a href="./Chapter26.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        X Iso Scroll
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="Chapter27.html">
            
                
                    <a href="./Chapter27.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        X Rotating Hero
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="Chapter28.html">
            
                
                    <a href="./Chapter28.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        X Rotating Ground
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="Chapter29.html">
            
                
                    <a href="./Chapter29.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        X Slopes
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="Chapter30.html">
            
                
                    <a href="./Chapter30.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                        X Hexagons
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="25" data-path="Chapter7.html">
            
                
                    <a href="./Chapter7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>25.</b>
                        
                        X More Tiles
                    </a>
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                Published with GitBook
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="./" >Introduction</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="cleaning-up">Cleaning Up</h1>
<p>We can now open doors to multiple rooms in the game. Very cool! But our <code>Game</code> class got very mangled in the process. There is now considetably more code in there! You can imagint the situation will quickly get out of hand as we add more rooms.</p>
<p>Each room makes for a pretty good object. In this section we&apos;re going to clean the code up a bit by refactoring the rooms into objects, and hopefully getting the <code>Game</code> class back under control.</p>
<p>We&apos;re going to call this new object that represent a room <code>Map</code>.</p>
<h3 id="tile-refactor">Tile Refactor</h3>
<p>Before we create the new <code>Map</code> class, lets make a quick change to the <code>Tile</code> class. In <strong>Tile.cs</strong> add a public bool to this class, call it <strong>IsDoor</strong>. It should be false by default.</p>
<p>Now, inside <strong>Game.cs</strong>, in the <code>GenerateMap</code> function where we set the <code>Walkable</code> variable, also set the IsDoor variable. It&apos;s going to be true if the layout tile is 2, false otherwise. </p>
<p>Finally, in <strong>Game.cs</strong> let&apos;s change the <code>Update</code> method. The part where it loops trough the <code>currentLayout</code> variable and checks the layout index if it&apos;s a door or not, this part:</p>
<pre><code class="lang-cs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> row = <span class="hljs-number">0</span>; row &lt; currentLayout.Length; ++row) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> col = <span class="hljs-number">0</span>; col &lt; currentLayout[row].Length; ++col) {
        <span class="hljs-comment">// The tile is a door if it had a 2 in the layout!</span>
        <span class="hljs-keyword">if</span> (currentLayout[row][col] == <span class="hljs-number">2</span>) {
</code></pre>
<p>Let&apos;s change that to loop trough the tiles (<code>currentRoom</code>) and check the new bool we added. The refactored code looks like this:</p>
<pre><code class="lang-cs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> row = <span class="hljs-number">0</span>; row &lt; currentRoom.Length; ++row) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> col = <span class="hljs-number">0</span>; col &lt; currentRoom[row].Length; ++col) {
        <span class="hljs-comment">// The tile is a door if it had a 2 in the layout!</span>
        <span class="hljs-keyword">if</span> (currentRoom[row][col].IsDoor) {
</code></pre>
<p>Go ahead, <strong>Run the game</strong>. It plays like nothing has happened. If there is no visual difference, why did we make this change? Simple, this loop and tile check was the only reason we needed to keep the <code>currentLayout</code> variable around. Now, when we refactor <code>`Map</code> to be it&apos;s own object, it won&apos;t need to track layout.</p>
<p>Given that there are no more practical references to <code>currentLayout</code> anymore, go ahead and remove the variable. Delete it&apos;s definition and any lingering assignments. Get the code to compile without it.</p>
<p>This isn&apos;t the last refactor we&apos;re going to make to the Tile class in this section, but let&apos;s hold off on the other refactors until they make sense.</p>
<h3 id="map-class">Map class</h3>
<p>Go ahead and create a new file, let&apos;s call it <strong>Map.cs</strong>. We&apos;re not going to add a lot of new code to this class, or the most part we&apos;re just going to move code out of <strong>Game.cs</strong> and into here.</p>
<p>A map is just a 2D array of <code>Tile</code> objects, so lets add a protected 2D <code>Tile</code> array to this class and call it <strong>tileMap</strong>. If we expose the same API as an array being used, then the <code>Map</code> class and a 2D int array will behave the same (inside of <strong>Game.cs</strong>). So what do we need to mimic an array API? We need a bracket accessor and a .Length property.</p>
<p>So far our class looks like this:</p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> System.Drawing;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">OpenTheDoor</span> {
    <span class="hljs-keyword">class</span> <span class="hljs-title">Map</span> {
        <span class="hljs-keyword">protected</span> Tile[][] tileMap = <span class="hljs-keyword">null</span>;

        <span class="hljs-comment">// Accessor to the tileMap variable. With this we can index the map object</span>
        <span class="hljs-comment">// without directly exposing the underlying tileMap. EX:</span>
        <span class="hljs-comment">// Map myMap = new Map();</span>
        <span class="hljs-comment">// myMap[row][col] = new Tile(row, col);</span>
        <span class="hljs-keyword">public</span> Tile[] <span class="hljs-keyword">this</span>[<span class="hljs-keyword">int</span> i] {
            <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> tileMap[i]; }
        }

        <span class="hljs-comment">// We may need to know how many rows / columns there are in the map, that&apos;s what</span>
        <span class="hljs-comment">// this function is great for!</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Length {
            <span class="hljs-keyword">get</span> {
                <span class="hljs-keyword">return</span> tileMap.Length;
            }
        }
    }
}
</code></pre>
<p>Next, let&apos;s add a constructor:</p>
<pre><code class="lang-cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Map</span>(<span class="hljs-params"><span class="hljs-keyword">int</span>[][] layout, <span class="hljs-keyword">string</span> sheets, Rectangle[] sources, <span class="hljs-keyword">params</span> <span class="hljs-keyword">int</span>[] walkable</span>) </span>{
</code></pre>
<p>If you notice the constructor here has a very similar signature to the <code>GenerateMap</code> function inside of <strong>Game.cs</strong>. That&apos;s because it essentially does the same thing. Go ahead and migrate the <code>GenerateMap</code> function into the map constructor.</p>
<p>Take these lines:</p>
<pre><code class="lang-cs">result[i][j].Walkable = layout[i][j] == <span class="hljs-number">0</span> || layout[i][j] == <span class="hljs-number">2</span>;
result[i][j].IsDoor = layout[i][j] == <span class="hljs-number">2</span>;
</code></pre>
<p>And replace them with sane defaults (don&apos;t worry, we will change these later):</p>
<pre><code class="lang-cs">result[i][j].Walkable = <span class="hljs-keyword">false</span>;
result[i][j].IsDoor = <span class="hljs-keyword">false</span>;
</code></pre>
<p>After setting all defaults, we want to loop trough the params argument at the end. If the value of the tile we just created is in the walkable array, then we should mark the tile as walkable.  Because an array doesn&apos;t have a search function, we will just do a linear search manually:</p>
<pre><code class="lang-cs"><span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">int</span> w <span class="hljs-keyword">in</span> walkable) {
    <span class="hljs-keyword">if</span> (layout[i][j] == w) {
        tileMap[i][j].Walkable = <span class="hljs-keyword">true</span>;
    }
}
</code></pre>
<p>It makes no sense for the <code>Game</code> class to have to loop torugh a room and destroy all textures indevidually. Same thing with rendering, why is the <code>Game</code> class looping? Let&apos;s fix that by moving the loops into the <code>Map</code> class like so:</p>
<pre><code class="lang-cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Render</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>; h &lt; tileMap.Length; h++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> w = <span class="hljs-number">0</span>; w &lt; tileMap[h].Length; w++) {
            tileMap[h][w].Render();
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Destroy</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>; h &lt; tileMap.Length; h++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> w = <span class="hljs-number">0</span>; w &lt; tileMap[h].Length; w++) {
            tileMap[h][w].Destroy();
        }
    }
}
</code></pre>
<p>That&apos;s our first round on the <code>Map</code> object, let&apos;s see what we need to do to <strong>Game.cs</strong> to make it work:</p>
<h3 id="game-refactor">Game refactor</h3>
<p>We have to do a little bit of re-factoring in the <code>Game</code> class to make it work with our new <code>Map</code> class. Here is a pretty comprehensive list of what needs to happen</p>
<ul>
<li>Change <code>Tile[][] room1 = null;</code> to <code>Map room1 = null</code></li>
<li>Repeat the above for room2</li>
<li>Repeat the above for currentRoom</li>
<li>Change the <code>Initialize</code> function to create a new <code>Map</code><ul>
<li>Last argument (params) is going to be 2 and 0 as they are walkable</li>
</ul>
</li>
<li>Inside <code>Initialize</code> still, map 1: manually set tile 4, 7 IsDoor to true</li>
<li>Inside <code>Initialize</code> still, map 2: manually set tile 0, 2 IsDoor to true</li>
<li>Delet the <code>GenerateMap</code> function from <strong>Game.cs</strong></li>
<li>In the <strong>Game.cs</strong>  <code>Destory</code> function, don&apos;t loop torugh maps. <ul>
<li>Call that map object&apos;s <code>Destroy</code> function instead</li>
</ul>
</li>
<li>In the <strong>Game.cs</strong> <code>Render</code> function, don&apos;t loop trough the currentMap.<ul>
<li>Instead just call <code>currentMap.Render();</code></li>
</ul>
</li>
</ul>
<p>If you need a reference, at this point my <strong>Game.cs</strong> looks like <a href="https://gist.github.com/gszauer/e4564c7a53582ecfeedf" target="_blank">This</a>. </p>
<p><strong>Run the game</strong>, at this point your game should run like if nothing had changed.</p>
<h3 id="whats-next">Whats next?</h3>
<p>The project is a little bit better orgonized now. We removed some code from <strong>*Game.cs</strong>, but not enough. I think we should be able to make the <code>Update</code> function into a 2 line function. I want it to work like this</p>
<pre><code>// PSEUDOCODE, NOT FOR PRODUCTION
public void Update(float dt) {
    hero.Update(dt);
    currentMap = currentMap.ResolveDoors(hero);
</code></pre><p>If the player leaves the room, <code>ResolveDoors</code> will return the new room the player is in, and move the player to the correct new location. In order to do this the map class will need to be able to check for doors, and the doors will need to know where to take the player. </p>
<h3 id="tile-refactor">Tile refactor</h3>
<p>Door tiles will need to know two more pieces of information, where the door should take the player in pixels on screen and which room to take the player to. With that in mind, add these two variables to <strong>Tile.cs</strong></p>
<ul>
<li><code>public Map DoorTarget = null;</code></li>
<li><code>public Point DoorLocation = new Point();</code></li>
</ul>
<p>Set them to good defaults (null, and empty Point). Next we&apos;re going to make a function that sets both of these, and the IsDoor variable. Lets call this function <strong>MakeDoor</strong> The function is super straight forward, this is what it looks like:</p>
<pre><code class="lang-cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MakeDoor</span>(<span class="hljs-params">Map target, Point location</span>) </span>{
    DoorTarget = target;
    DoorLocation = location;
    IsDoor = <span class="hljs-keyword">true</span>;
}
</code></pre>
<p>That&apos;s it, for the moment the <code>Tile</code> class is done. We&apos;re not going to be touching it for the rest of this section.</p>
<h3 id="map-refactor">Map Refactor</h3>
<p>Let&apos;s add a new method to the <code>Map</code> class. This is the method we&apos;re going to use to test if a door intersection has happened.Let&apos;s call that method <code>ResolveDoors</code> and give it the following signature:</p>
<pre><code class="lang-cs"><span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">ResolveDoors</span>(<span class="hljs-params">PlayerCharacter hero</span>) </span>{
</code></pre>
<p>Go ahead and <strong>try to move</strong> the door related update function out of <strong>Game.cs</strong> and into <strong>Map.cs</strong> I expect you will have a hard time with the code that decides that a collision has happened. Again, the code here is pretty straight forward, i&apos;ll include my version:</p>
<pre><code class="lang-cs"><span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">ResolveDoors</span>(<span class="hljs-params">PlayerCharacter hero</span>) </span>{
    Map result = <span class="hljs-keyword">this</span>; <span class="hljs-comment">// Return this map by default!</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> row = <span class="hljs-number">0</span>; row &lt; tileMap.Length; ++row) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> col = <span class="hljs-number">0</span>; col &lt; tileMap[row].Length; ++col) {
            <span class="hljs-keyword">if</span> (tileMap[row][col].IsDoor) {
                Rectangle doorRect = <span class="hljs-keyword">new</span> Rectangle(col * <span class="hljs-number">30</span>, row * <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>);
                Rectangle playerCenter = <span class="hljs-keyword">new</span> Rectangle((<span class="hljs-keyword">int</span>)hero.Center.X - <span class="hljs-number">2</span>, (<span class="hljs-keyword">int</span>)hero.Center.Y - <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);
                Rectangle intersection = Intersection.Rect(doorRect, playerCenter);

                <span class="hljs-comment">// Intersection happens if the intersect rectangle has an area &gt; 0</span>
                <span class="hljs-keyword">if</span> (intersection.Width * intersection.Height &gt; <span class="hljs-number">0</span>) {
                    result = tileMap[row][col].DoorTarget;
                    hero.Position.X = tileMap[row][col].DoorLocation.X * <span class="hljs-number">30</span>;
                    hero.Position.Y = tileMap[row][col].DoorLocation.Y * <span class="hljs-number">30</span>;
                }
            }
        }
    }

    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>That&apos;s a short, good looking function! And with that we are done refactoring the <code>Map</code> class. We just need to fix up <strong>Game.cs</strong> now.</p>
<h3 id="game-refactor">Game Refactor</h3>
<p>I order to utilize these shiny new features we&apos;ve added we have to do some refactoring on <strong>Game.cs</strong>, luckly, it&apos;s just two things:</p>
<ul>
<li>In initialize, wehre we where setting <code>`IsDoor</code> to true, don&apos;t do that<ul>
<li>Instead call the <code>MakeDoor</code> function of <code>Tile</code></li>
</ul>
</li>
<li>In Update, tear out that big ugly nested loop ment for door checks.<ul>
<li>Replace it with: <code>currentRoom = currentRoom.ResolveDoors(hero);</code> </li>
</ul>
</li>
</ul>
<p>And that&apos;s it! You should now be able to <strong>Run Your Game</strong>, and it should look exactly like our game did at the begening of the tutorial. The big difference? The code is now maintainable! In fact, the <strong>Game.cs</strong> class ended up so small, i&apos;m going to include it verbatin:</p>
<pre><code class="lang-cs"><span class="hljs-keyword">using</span> GameFramework;
<span class="hljs-keyword">using</span> System.Drawing;
<span class="hljs-keyword">using</span> Collision;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">OpenTheDoor</span> {
    <span class="hljs-keyword">class</span> <span class="hljs-title">Game</span> {
        <span class="hljs-keyword">protected</span> Point spawnTile = <span class="hljs-keyword">new</span> Point(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">protected</span> PlayerCharacter hero = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> heroSheet = <span class="hljs-string">&quot;Assets/Link.png&quot;</span>;
        <span class="hljs-keyword">public</span> OpenTK.GameWindow Window = <span class="hljs-keyword">null</span>;

        Map room1 = <span class="hljs-keyword">null</span>;
        Map room2 = <span class="hljs-keyword">null</span>;
        Map currentRoom = <span class="hljs-keyword">null</span>;

        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span>[][] room1Layout = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[][] {
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span> }
        };

        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span>[][] room2Layout = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[][] {
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> },
            <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span> }
        };

        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> spriteSheets = <span class="hljs-string">&quot;Assets/HouseTiles.png&quot;</span>;
        <span class="hljs-keyword">protected</span> Rectangle[] spriteSources = <span class="hljs-keyword">new</span> Rectangle[] {
            <span class="hljs-keyword">new</span> Rectangle(<span class="hljs-number">466</span>,<span class="hljs-number">32</span>,<span class="hljs-number">30</span>,<span class="hljs-number">30</span>),
            <span class="hljs-keyword">new</span> Rectangle(<span class="hljs-number">466</span>,<span class="hljs-number">1</span>,<span class="hljs-number">30</span>,<span class="hljs-number">30</span>),
            <span class="hljs-keyword">new</span> Rectangle(<span class="hljs-number">32</span>, <span class="hljs-number">187</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>),
            <span class="hljs-keyword">new</span> Rectangle(<span class="hljs-number">32</span>, <span class="hljs-number">187</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>)
        };

        <span class="hljs-function"><span class="hljs-keyword">public</span> Tile <span class="hljs-title">GetTile</span>(<span class="hljs-params">PointF pixelPoint</span>) </span>{
            <span class="hljs-keyword">return</span> currentRoom[(<span class="hljs-keyword">int</span>)pixelPoint.Y / <span class="hljs-number">30</span>][(<span class="hljs-keyword">int</span>)pixelPoint.X / <span class="hljs-number">30</span>];
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> Rectangle <span class="hljs-title">GetTileRect</span>(<span class="hljs-params">PointF pixelPoint</span>) </span>{
            <span class="hljs-keyword">int</span> xTile = (<span class="hljs-keyword">int</span>)pixelPoint.X / <span class="hljs-number">30</span>;
            <span class="hljs-keyword">int</span> yTile = (<span class="hljs-keyword">int</span>)pixelPoint.Y / <span class="hljs-number">30</span>;
            Rectangle result = <span class="hljs-keyword">new</span> Rectangle(xTile * <span class="hljs-number">30</span>, yTile * <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>);
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Game instance = <span class="hljs-keyword">null</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Game Instance {
            <span class="hljs-keyword">get</span> {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-keyword">null</span>) {
                    instance = <span class="hljs-keyword">new</span> Game();
                }
                <span class="hljs-keyword">return</span> instance;
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">Game</span>(<span class="hljs-params"></span>) </span>{

        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Initialize</span>(<span class="hljs-params">OpenTK.GameWindow window</span>) </span>{
            Window = window;
            window.ClientSize = <span class="hljs-keyword">new</span> Size(room1Layout[<span class="hljs-number">0</span>].Length * <span class="hljs-number">30</span>, room1Layout.Length * <span class="hljs-number">30</span>);
            TextureManager.Instance.UseNearestFiltering = <span class="hljs-keyword">true</span>;

            hero = <span class="hljs-keyword">new</span> PlayerCharacter(heroSheet, <span class="hljs-keyword">new</span> Point(spawnTile.X * <span class="hljs-number">30</span>, spawnTile.Y * <span class="hljs-number">30</span>));
            room1 = <span class="hljs-keyword">new</span> Map(room1Layout, spriteSheets, spriteSources, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// 0 and 2 ae walkable</span>
            room2 = <span class="hljs-keyword">new</span> Map(room2Layout, spriteSheets, spriteSources, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// 0 and 2 are walkable</span>
            currentRoom = room1;

            room1[<span class="hljs-number">4</span>][<span class="hljs-number">7</span>].MakeDoor(room2, <span class="hljs-keyword">new</span> Point(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)); <span class="hljs-comment">// Go to room2, at tile 1, 1</span>
            room2[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>].MakeDoor(room1, <span class="hljs-keyword">new</span> Point(<span class="hljs-number">6</span>, <span class="hljs-number">4</span>)); <span class="hljs-comment">// To to room1, at tile 6, 4</span>
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> dt</span>) </span>{
            hero.Update(dt);
            currentRoom = currentRoom.ResolveDoors(hero);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Render</span>(<span class="hljs-params"></span>) </span>{
            currentRoom.Render();
            hero.Render();
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Shutdown</span>(<span class="hljs-params"></span>) </span>{
            room1.Destroy();
            room2.Destroy();
            hero.Destroy();
        }
    }
}
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="./Chapter11.html" class="navigation navigation-prev " aria-label="Previous page: Open The Door"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="./borders.html" class="navigation navigation-next " aria-label="Next page: Screen Borders"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
